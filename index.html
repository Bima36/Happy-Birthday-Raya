<script>
    // Floating hearts
    const heartsContainer = document.getElementById('hearts');
    const heartEmojis = ['ðŸŒ¸', 'ðŸ’—', 'âœ¨', 'ðŸŒ·', 'ðŸ’•', 'ðŸŽ€'];
    function spawnHeart() {
        const el = document.createElement('div');
        el.className = 'heart';
        el.textContent = heartEmojis[Math.floor(Math.random() * heartEmojis.length)];
        el.style.left = Math.random() * 100 + 'vw';
        el.style.fontSize = (Math.random() * 16 + 10) + 'px';
        const dur = Math.random() * 8 + 7;
        el.style.animation = `floatHeart ${dur}s linear forwards`;
        heartsContainer.appendChild(el);
        setTimeout(() => el.remove(), dur * 1000);
    }
    setInterval(spawnHeart, 1400);
    spawnHeart(); spawnHeart();

    // Elements
    const overlay  = document.getElementById('surpriseOverlay');
    const giftBtn  = document.getElementById('giftBtn');
    const closeBtn = document.getElementById('closeBtn');

    // Open surprise
    giftBtn.addEventListener('click', function() {
        overlay.classList.add('active');
        spawnConfetti();
    });

    // ======== CLOSE BUTTON - semua cara ========
    closeBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        overlay.classList.remove('active');
    });
    closeBtn.addEventListener('touchend', function(e) {
        e.preventDefault();
        e.stopPropagation();
        overlay.classList.remove('active');
    });
    // Klik background juga tutup
    overlay.addEventListener('click', function(e) {
        if (e.target === overlay) overlay.classList.remove('active');
    });
    // ESC keyboard
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') overlay.classList.remove('active');
    });

    // Confetti
    function spawnConfetti() {
        const colors = ['#ee9ca7','#ffd6e0','#f9d4c0','#8b6a60','#ffffff','#ffecd2'];
        for (let i = 0; i < 80; i++) {
            setTimeout(() => {
                const c = document.createElement('div');
                c.className = 'confetti-piece';
                c.style.left = Math.random() * 100 + 'vw';
                c.style.background = colors[Math.floor(Math.random() * colors.length)];
                c.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
                const size = (Math.random() * 8 + 6) + 'px';
                c.style.width = size; c.style.height = size;
                const dur = Math.random() * 2 + 2.5;
                c.style.animation = `confettiFall ${dur}s ease-in forwards`;
                c.style.animationDelay = (Math.random() * 0.5) + 's';
                document.body.appendChild(c);
                setTimeout(() => c.remove(), (dur + 0.5) * 1000);
            }, i * 25);
        }
    }

    // ==== FITUR TIUP LILIN (AMAN) ====
    let audioContext;
    let analyser;
    let mic;
    let isListening = false;

    function startMic() {
        if (isListening) return; // Cegah multiple activation
        
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                isListening = true;
                audioContext = new AudioContext();
                mic = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                mic.connect(analyser);

                const data = new Uint8Array(analyser.frequencyBinCount);

                function detectBlow() {
                    analyser.getByteFrequencyData(data);
                    let volume = data.reduce((a,b)=>a+b) / data.length;

                    if(volume > 55){
                        blowOut();
                        stopMic(stream); // Stop setelah terdeteksi
                    } else {
                        requestAnimationFrame(detectBlow);
                    }
                }

                detectBlow();
            })
            .catch(error => {
                console.warn('Microphone access denied:', error);
                // Fitur blow candle tidak akan berfungsi
            });
    }

    function stopMic(stream) {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        isListening = false;
    }

    function blowOut(){
        const velas = document.querySelector('.velas');
        if (velas) {
            velas.classList.add("off");
        }
    }

    // Panggil saat halaman siap (opsional: uncomment jika ingin auto-activate)
    // document.addEventListener('DOMContentLoaded', startMic);
    
    // Atau panggil ketika user klik tombol gift (lebih user-friendly)
    giftBtn.addEventListener('click', function() {
        setTimeout(() => startMic(), 500); // Delay agar tidak conflict
    });
</script>
